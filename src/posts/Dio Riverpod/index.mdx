# Dio+Riverpod

```
âœ” é«˜æ•ˆç½‘ç»œè¯·æ±‚ï¼ˆè‡ªåŠ¨é‡è¯• + Token ç®¡ç†ï¼‰
âœ” ç¨³å®šçš„ç¼“å­˜æœºåˆ¶ï¼ˆçŸ­æ—¶é—´å†…é˜²æ­¢é‡å¤è¯·æ±‚ï¼‰
âœ” çµæ´»çš„æ§åˆ¶ï¼ˆæ”¯æŒ forceRefresh å¼ºåˆ¶åˆ·æ–°ï¼‰
âœ” ç»“åˆ Riverpodï¼ˆè®©å…¨å±€çŠ¶æ€ç®¡ç†æ›´æ¸…æ™°ï¼‰
```

1. å®‰è£…ä¾èµ–

```yaml
dependencies:
  dio: ^5.0.0
  retry: ^3.1.2
  shared_preferences: ^2.2.0
  pretty_dio_logger: ^1.3.1
  dio_cache_interceptor: ^3.4.0
  dio_cache_interceptor_hive_store: ^3.1.0
  hive: ^2.2.3
  hive_flutter: ^1.1.0

```

2. å¼•å…¥ Hive è¿›è¡ŒæŒä¹…åŒ–ç¼“å­˜

- ä½¿ç”¨ Hive ä½œä¸ºç¼“å­˜å­˜å‚¨ï¼Œé¿å… SharedPreferences ä¸èƒ½å­˜äºŒè¿›åˆ¶æ•°æ®çš„é™åˆ¶

```dart
import 'package:hive/hive.dart';
import 'package:hive_flutter/hive_flutter.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Hive.initFlutter();  // åˆå§‹åŒ– Hive
  await dioClient.init(); // åˆå§‹åŒ– DioClient
  runApp(ProviderScope(child: MyApp()));
}

```

3. æ·»åŠ ç¼“å­˜æ‹¦æˆªå™¨


```dart
import 'dart:async';
import 'package:dio/dio.dart';
import 'package:retry/retry.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:pretty_dio_logger/pretty_dio_logger.dart';
import 'package:dio_cache_interceptor/dio_cache_interceptor.dart';
import 'package:dio_cache_interceptor_hive_store/dio_cache_interceptor_hive_store.dart';
import 'package:hive/hive.dart';

class DioClient {
  late final Dio _dio;
  late final SharedPreferences _prefs;
  late final CacheStore _cacheStore;

  DioClient._internal(); // ç§æœ‰æ„é€ å‡½æ•°
  static final DioClient _instance = DioClient._internal();
  factory DioClient() => _instance; // å•ä¾‹æ¨¡å¼

  Future<void> init() async {
    _prefs = await SharedPreferences.getInstance();
    _cacheStore = HiveCacheStore(await Hive.openBox('dio_cache')); // ä½¿ç”¨ Hive å­˜å‚¨ç¼“å­˜

    _dio = Dio(
      BaseOptions(
        baseUrl: "https://api.example.com",
        connectTimeout: const Duration(seconds: 10),
        receiveTimeout: const Duration(seconds: 10),
        headers: {"Content-Type": "application/json"},
      ),
    );

    // æ·»åŠ æ‹¦æˆªå™¨
    _dio.interceptors.addAll([
      _AuthInterceptor(this), // è‡ªåŠ¨é™„åŠ  Token
      _RetryInterceptor(),    // è‡ªåŠ¨é‡è¯•
      _CacheInterceptor(_cacheStore), // ç¼“å­˜
      _LogInterceptor(),      // è¯·æ±‚æ—¥å¿—
    ]);
  }

  Future<Response> get(String path, {Map<String, dynamic>? params, bool forceRefresh = false}) async {
    return await _executeWithRetry(() => _dio.get(path, queryParameters: params, options: forceRefresh ? Options(extra: {'refresh': true}) : null));
  }

  Future<Response> post(String path, {Map<String, dynamic>? data}) async {
    return await _executeWithRetry(() => _dio.post(path, data: data));
  }

  Future<Response> _executeWithRetry(Future<Response> Function() request) async {
    return await retry(
      request,
      retryIf: (e) => e is DioException && e.type == DioExceptionType.connectionTimeout,
      maxAttempts: 3,
    );
  }

  Future<void> clearCache() async {
    await _cacheStore.clean();
  }

  Dio get dio => _dio;
}

final dioClient = DioClient();

```

âœ… æ·»åŠ  _CacheInterceptor å¤„ç† GET è¯·æ±‚ç¼“å­˜
âœ… forceRefresh å‚æ•°å¯æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜
âœ… æä¾› clearCache() æ–¹æ³•æ¸…ç†ç¼“å­˜

4. ç¼“å­˜æ‹¦æˆªå™¨
- æ–°å»º _CacheInterceptorï¼š
```dart
class _CacheInterceptor extends Interceptor {
  final CacheStore cacheStore;
  _CacheInterceptor(this.cacheStore);

  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) async {
    if (options.extra['refresh'] == true) {
      await cacheStore.clean(); // å¦‚æœ `refresh=true`ï¼Œåˆ™æ¸…ç†ç¼“å­˜
    }
    return handler.next(options);
  }

  @override
  void onResponse(Response response, ResponseInterceptorHandler handler) {
    if (response.requestOptions.method == "GET") {
      cacheStore.set(
        CacheResponse(
          key: response.requestOptions.uri.toString(),
          content: response.data,
          statusCode: response.statusCode!,
          headers: response.headers.map,
          requestDate: DateTime.now(),
          responseDate: DateTime.now(),
          maxStale: const Duration(minutes: 5), // ç¼“å­˜ 5 åˆ†é’Ÿ
        ),
      );
    }
    return handler.next(response);
  }

  @override
  void onError(DioException err, ErrorInterceptorHandler handler) async {
    final cached = await cacheStore.get(err.requestOptions.uri.toString());
    if (cached != null) {
      return handler.resolve(Response(
        requestOptions: err.requestOptions,
        statusCode: cached.statusCode,
        data: cached.content,
        headers: Headers.fromMap(cached.headers),
      ));
    }
    return handler.next(err);
  }
}

```

âœ… ç¼“å­˜ GET è¯·æ±‚
âœ… å½“ç½‘ç»œé”™è¯¯æ—¶ï¼Œè‡ªåŠ¨è¿”å›ç¼“å­˜æ•°æ®
âœ… æ”¯æŒ forceRefresh å¼ºåˆ¶åˆ·æ–°

5. åœ¨ Riverpod é‡Œä½¿ç”¨

```dart
final dioProvider = Provider<Dio>((ref) => dioClient.dio);

// è·å–ç”¨æˆ·æ•°æ®ï¼ˆ5 åˆ†é’Ÿç¼“å­˜ï¼‰
final userProvider = FutureProvider<Map<String, dynamic>>((ref) async {
  final dio = ref.watch(dioProvider);
  final response = await dio.get('/user');
  return response.data;
});

// è·å–æœ€æ–°ç”¨æˆ·æ•°æ®ï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰
final freshUserProvider = FutureProvider<Map<String, dynamic>>((ref) async {
  final dio = ref.watch(dioProvider);
  final response = await dio.get('/user', options: Options(extra: {'refresh': true}));
  return response.data;
});

```

âœ… userProvider ä¼šè‡ªåŠ¨ç¼“å­˜ 5 åˆ†é’Ÿ
âœ… freshUserProvider å¼ºåˆ¶åˆ·æ–°æ•°æ®

6. æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜

```dart
void clearCache() async {
  await dioClient.clearCache();
  print("ç¼“å­˜å·²æ¸…é™¤ï¼");
}
```

âœ… è°ƒç”¨ dioClient.clearCache() å¯æ¸…é™¤æ‰€æœ‰ç¼“å­˜


7. ğŸ”¥ ç»ˆæä¼˜åŒ–æ€»ç»“
```html
åŠŸèƒ½ï¼šè§£å†³æ–¹æ¡ˆ
Token å­˜å‚¨ï¼šSharedPreferences æŒä¹…åŒ–
Token è‡ªåŠ¨åˆ·æ–°ï¼š401 è§¦å‘ _refreshToken()
ç½‘ç»œè¯·æ±‚è‡ªåŠ¨é‡è¯•ï¼š_RetryInterceptor
æ—¥å¿—æ‰“å°ï¼š_LogInterceptor
GET è¯·æ±‚ç¼“å­˜ï¼š_CacheInterceptor + HiveCacheStore
å¼ºåˆ¶åˆ·æ–°æ•°æ®ï¼šextra: {'refresh': true}
è‡ªåŠ¨è¿”å›ç¼“å­˜æ•°æ®ï¼šç½‘ç»œé”™è¯¯æ—¶è¿”å›ç¼“å­˜æ•°æ®
æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜ï¼šdioClient.clearCache()
```
